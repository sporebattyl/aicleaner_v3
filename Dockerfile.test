# Simple test Dockerfile using Python base image instead of HA base
FROM python:3.12-alpine

# Install bash first, then set it as shell
RUN apk add --no-cache bash

# Set shell for RUN commands
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Install debugging and development tools
RUN apk add --no-cache \
    curl \
    wget \
    git \
    vim \
    nano \
    htop \
    net-tools \
    jq \
    && pip3 install --no-cache-dir \
    paho-mqtt \
    aiohttp \
    aiofiles \
    PyYAML \
    requests

# Create app user and directories
RUN addgroup -S app && adduser -S -G app app
RUN mkdir -p /data /config /app && chown -R app:app /data /config /app

# Set working directory
WORKDIR /app

# Copy addon source code and run script
COPY src/ ./src/
COPY run.sh /
RUN chmod a+x /run.sh

# Set environment variables for debugging
ENV PYTHONUNBUFFERED=1

# Create simple entrypoint that bypasses HA init
CMD ["/run.sh"]